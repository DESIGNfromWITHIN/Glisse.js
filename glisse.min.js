/*
* jQuery Glisse plugin
* ---
* @author: Victor
* @authorurl: http://victorcoulon.fr
* @twitter: http://twitter.com/_victa
*
* Based on jQuery Plugin Boilerplate 1.3
*
*/

(function(a){a.glisse=function(b,d){var e=this;e.settings={};e.els={};var q=a(b);var l={dataName:"data-glisse-big",speed:300,changeSpeed:1000,effect:"bounce",mobile:false};var n,j,v=false,h={};e.init=function(){e.settings=a.extend({},l,d);a.MobileDevice=((navigator.userAgent.match(/iPhone/i))||(navigator.userAgent.match(/iPod/i))||(navigator.userAgent.match(/Android/i)));a.Tablet=((navigator.userAgent.match(/iPad/i)));n=a(q).attr(e.settings.dataName);j=q.attr("rel")||null;e.settings.mobile=(a.Tablet||a.MobileDevice)?true:false;q.on("click",function(){p();r();m(n);g();k();a(document).keydown(function(w){if(w.keyCode.toString()==="27"){c()}if(w.keyCode.toString()==="39"){o("next")}if(w.keyCode.toString()==="37"){o("prev")}});if(e.settings.mobile){mobile={touching:false,nx:0,oX:0,scrollX:null};document.ontouchmove=function(w){t(w)};document.ontouchstart=function(w){t(w)};document.ontouchend=function(w){t(w)};if(!i()){}}})};var p=function p(){q.addClass("active");var x=s("transition")+"transition",w="opacity "+e.settings.speed+"ms ease, "+s("transform")+"transform "+e.settings.speed+"ms ease";e.els.overlay=a(document.createElement("div")).attr("id","glisse-overlay").css(x,w);e.els.spinner=a(document.createElement("div")).attr("id","glisse-spinner");e.els.close=a(document.createElement("span")).attr("id","glisse-close").css(x,w);e.els.content=a(document.createElement("div")).attr("id","glisse-overlay-content").css(x,w).css(s("transform")+"transform","scale(0)");e.els.controls=a(document.createElement("div")).attr("id","glisse-controls").css(x,w);e.els.controlNext=a(document.createElement("span")).attr("class","glisse-next").append(a(document.createElement("a")).html("&#62;").attr("href","#"));e.els.controlLegend=a(document.createElement("span")).attr("class","glisse-legend");e.els.controlPrev=a(document.createElement("span")).attr("class","glisse-prev").append(a(document.createElement("a")).html("&#60;").attr("href","#"));e.els.overlay.append(e.els.spinner);e.els.controls.append(e.els.controlNext,e.els.controlLegend,e.els.controlPrev);a("body").append(e.els.overlay,e.els.close,e.els.content,e.els.controls);u.observe("glisse-overlay",function(){e.els.overlay.css("opacity",1)});u.observe("glisse-close",function(){e.els.close.css("opacity",1)});u.observe("glisse-controls",function(){e.els.controls.css("opacity",1)});e.els.controls.delegate("a","click",function(y){y.preventDefault();var z=(a(this).parent().hasClass("glisse-next"))?"next":"prev";o(z)});e.els.overlay.on("click",function(){c()});e.els.content.on("click",function(){c()});e.els.close.on("click",function(){c()})};var c=function c(){e.els.content.css({opacity:0}).css(s("transform")+"transform","scale(1.2)");e.els.overlay.css({opacity:0});e.els.close.css({opacity:0});e.els.controls.css({opacity:0});setTimeout(function(){e.els.content.remove();e.els.overlay.remove();e.els.close.remove();e.els.controls.remove();a("#glisse-transition-css").remove()},e.settings.speed);n=a(q).attr(e.settings.dataName);q.removeClass("active");document.ontouchmove=function(w){return true};document.ontouchstart=function(w){return true};document.ontouchend=function(w){return true};a(document).unbind("keydown")};var m=function m(y){f(true);var x=y+"?"+Math.random(),w=a("<img/>",{src:x}).appendTo(e.els.content);e.els.content.css({backgroundImage:"url("+x+")"});w.load(function(){w.remove();f(false);e.els.content.css({visibility:"visible",opacity:1}).css(s("transform")+"transform","scale(1)")})};var o=function o(C){var z=a('img[data-glisse-big="'+n+'"]'),x=a("img[rel="+j+"]").index(z),A=a("img[rel="+j+"]").length,D=true;if((x===0&&C==="prev")||(x===(A-1)&&C==="next")){D=false}if(D&&v===false){v=true;var y=(C==="next")?a("img[rel="+j+"]").eq(x+1):a("img[rel="+j+"]").eq(x-1);if(e.settings.mobile){if(C!=="next"){e.els.content.css(s("transform")+"transform","translateX(2000px)")}else{e.els.content.css(s("transform")+"transform","translateX(-2000px)")}}else{e.els.content.addClass("glisse-transitionOut-"+C);var B=s("transition")+"transition",w="opacity "+e.settings.speed+"ms ease, "+s("transform")+"transform "+e.settings.speed+"ms ease";e.els.content.css(B,"")}f(true);z.removeClass("active");y.addClass("active");n=y.attr(e.settings.dataName);g();k();setTimeout(function(){if(e.settings.mobile){e.els.content.css(s("transform")+"transform","translateX(0px)").css("display","none")}var F=n+"?"+Math.random(),E=a("<img/>",{src:F}).appendTo(e.els.content);e.els.content.css({backgroundImage:"url("+F+")"});E.load(function(){E.remove();f(false);if(e.settings.mobile){e.els.content.css("display","block")}e.els.content.removeClass("glisse-transitionOut-"+C).addClass("glisse-transitionIn-"+C);setTimeout(function(){e.els.content.removeClass("glisse-transitionIn-"+C).css(B,w);v=false},e.settings.changeSpeed)})},e.settings.changeSpeed)}else{if(D===false&&v===false){if(e.settings.mobile){e.els.content.css(s("transform")+"transform","translateX(0px)")}e.els.content.addClass("shake");setTimeout(function(){e.els.content.removeClass("shake")},600)}}};var r=function r(){var y=s("transform");var z=s("animation");var w=[];switch(e.settings.effect){case"bounce":w=["@"+z+"keyframes outLeft {","0% { "+y+"transform: translateX(0);}","20% { opacity: 1;"+y+"transform: translateX(20px);}","100% { opacity: 0;"+y+"transform: translateX(-2000px);}","}","@"+z+"keyframes inLeft {","0% {opacity: 0;"+y+"transform: translateX(-2000px);}","60% {opacity: 1;"+y+"transform: translateX(30px);}","80% {"+y+"transform: translateX(-10px);}","100% {"+y+"transform: translateX(0);}","}","@"+z+"keyframes outRight {","0% {"+y+"transform: translateX(0);}","20% {opacity: 1;"+y+"transform: translateX(-20px);}","100% {opacity: 0;"+y+"transform: translateX(2000px);}","}","@"+z+"keyframes inRight {","0% {opacity: 0;"+y+"transform: translateX(2000px);}","60% {opacity: 1;"+y+"transform: translateX(-30px);}","80% {"+y+"transform: translateX(10px);}","100% {"+y+"transform: translateX(0);}","}"].join("");break;case"fadeBig":w=["@"+z+"keyframes outLeft {","0% { opacity: 1;"+y+"transform: translateX(0);}","100% {opacity: 0;"+y+"transform: translateX(-2000px);}","}","@"+z+"keyframes inLeft {","0% { opacity: 0;"+y+"transform: translateX(-2000px);}","100% {opacity: 1;"+y+"transform: translateX(0);}","}","@"+z+"keyframes outRight {","0% { opacity: 1;"+y+"transform: translateX(0);}","100% {opacity: 0;"+y+"transform: translateX(2000px);}","}","@"+z+"keyframes inRight {","0% { opacity: 0;"+y+"transform: translateX(2000px);}","100% {opacity: 1;"+y+"transform: translateX(0);}","}"].join("");break;case"fade":w=["@"+z+"keyframes outLeft {","0% { opacity: 1;"+y+"transform: translateX(0);}","100% {opacity: 0;"+y+"transform: translateX(-200px);}","}","@"+z+"keyframes inLeft {","0% { opacity: 0;"+y+"transform: translateX(-200px);}","100% {opacity: 1;"+y+"transform: translateX(0);}","}","@"+z+"keyframes outRight {","0% { opacity: 1;"+y+"transform: translateX(0);}","100% {opacity: 0;"+y+"transform: translateX(200px);}","}","@"+z+"keyframes inRight {","0% { opacity: 0;"+y+"transform: translateX(200px);}","100% {opacity: 1;"+y+"transform: translateX(0);}","}"].join("");break;case"roll":w=["@"+z+"keyframes outLeft {","0% { opacity: 1;"+y+"transform: translateX(0px) rotate(0deg);}","100% {opacity: 0;"+y+"transform: translateX(-100%) rotate(-120deg);}","}","@"+z+"keyframes inLeft {","0% { opacity: 0;"+y+"transform: translateX(-100%) rotate(-120deg);}","100% {opacity: 1;"+y+"transform:  translateX(0px) rotate(0deg);}","}","@"+z+"keyframes outRight {","0% { opacity: 1;"+y+"transform:translateX(0px) rotate(0deg);}","100% {opacity: 0;"+y+"transform:translateX(100%) rotate(120deg);}","}","@"+z+"keyframes inRight {","0% { opacity: 0;"+y+"transform: translateX(100%) rotate(120deg);}","100% {opacity: 1;"+y+"transform:  translateX(0px) rotate(0deg);}","}"].join("");break;case"rotate":w=["@"+z+"keyframes outRight {","0% { opacity: 1;"+y+"transform: rotate(0deg);"+y+"transform-origin:left bottom;}","100% {opacity: 0;"+y+"transform: rotate(-90deg);"+y+"transform-origin:left bottom;}","}","@"+z+"keyframes inLeft {","0% { opacity: 0;"+y+"transform: rotate(90deg);"+y+"transform-origin:left bottom;}","100% {opacity: 1;"+y+"transform: rotate(0deg);"+y+"transform-origin:left bottom;}","}","@"+z+"keyframes outLeft {","0% { opacity: 1;"+y+"transform: rotate(0deg);"+y+"transform-origin:right bottom;}","100% {opacity: 0;"+y+"transform: rotate(90deg);"+y+"transform-origin:right bottom;}","}","@"+z+"keyframes inRight {","0% { opacity: 0;"+y+"transform: rotate(-90deg);"+y+"transform-origin:right bottom;}","100% {opacity: 1;"+y+"transform: rotate(0deg);"+y+"transform-origin:right bottom;}","}"].join("");break;case"flipX":w=["@"+z+"keyframes outLeft {","0% {"+y+"transform: perspective(400px) rotateX(0deg);opacity: 1;}","100% {"+y+"transform: perspective(400px) rotateX(90deg);opacity: 0;}","}","@"+z+"keyframes inLeft {","0% {"+y+"transform: perspective(400px) rotateX(90deg);opacity: 0;}","40% {"+y+"transform: perspective(400px) rotateX(-10deg);}","70% {"+y+"transform: perspective(400px) rotateX(10deg);}","100% {"+y+"transform: perspective(400px) rotateX(0deg);opacity: 1;}","}","@"+z+"keyframes outRight {","0% {"+y+"transform: perspective(400px) rotateX(0deg);opacity: 1;}","100% {"+y+"transform: perspective(400px) rotateX(90deg);opacity: 0;}","}","@"+z+"keyframes inRight {","0% {"+y+"transform: perspective(400px) rotateX(90deg);opacity: 0;}","40% {"+y+"transform: perspective(400px) rotateX(-10deg);}","70% {"+y+"transform: perspective(400px) rotateX(10deg);}","100% {"+y+"transform: perspective(400px) rotateX(0deg);opacity: 1;}","}"].join("");break;case"flipY":w=["@"+z+"keyframes outLeft {","0% {"+y+"transform: perspective(400px) rotateY(0deg);opacity: 1;}","100% {"+y+"transform: perspective(400px) rotateY(90deg);opacity: 0;}","}","@"+z+"keyframes inLeft {","0% {"+y+"transform: perspective(400px) rotateY(90deg);opacity: 0;}","40% {"+y+"transform: perspective(400px) rotateY(-10deg);}","70% {"+y+"transform: perspective(400px) rotateY(10deg);}","100% {"+y+"transform: perspective(400px) rotateY(0deg);opacity: 1;}","}","@"+z+"keyframes outRight {","0% {"+y+"transform: perspective(400px) rotateY(0deg);opacity: 1;}","100% {"+y+"transform: perspective(400px) rotateY(-90deg);opacity: 0;}","}","@"+z+"keyframes inRight {","0% {"+y+"transform: perspective(400px) rotateY(90deg);opacity: 0;}","40% {"+y+"transform: perspective(400px) rotateY(-10deg);}","70% {"+y+"transform: perspective(400px) rotateY(10deg);}","100% {"+y+"transform: perspective(400px) rotateY(0deg);opacity: 1;}","}"].join("");break}var x=[".glisse-transitionOut-next {",z+"animation: "+e.settings.changeSpeed+"ms ease;",z+"animation-name: outLeft;",z+"animation-fill-mode: both;","}",".glisse-transitionIn-prev {",z+"animation: "+e.settings.changeSpeed+"ms ease;",z+"animation-name: inLeft;",z+"animation-fill-mode: both;","}",".glisse-transitionOut-prev {",z+"animation: "+e.settings.changeSpeed+"ms ease;",z+"animation-name: outRight;",z+"animation-fill-mode: both;","}",".glisse-transitionIn-next {",z+"animation: "+e.settings.changeSpeed+"ms ease;",z+"animation-name: inRight;",z+"animation-fill-mode: both;","}"].join("");a('<style type="text/css" id="glisse-css">'+w+x+"</style>").appendTo("head")};var g=function g(){var w=a('img[data-glisse-big="'+n+'"]');if(!w.parent().next().find("img[rel="+j+"]").length){e.els.controls.find(".glisse-next").addClass("ended")}else{e.els.controls.find(".glisse-next").removeClass("ended")}if(!w.parent().prev().find("img[rel="+j+"]").length){e.els.controls.find(".glisse-prev").addClass("ended")}else{e.els.controls.find(".glisse-prev").removeClass("ended")}};var k=function k(){var x=e.els.controls.find(".glisse-legend");var w=a('img[data-glisse-big="'+n+'"]');var y=w.attr("title");x.html((y)?y:"")};var f=function f(w){if(w){e.els.overlay.addClass("loading")}else{e.els.overlay.removeClass("loading")}};var s=function s(A){var z=["Moz","Khtml","Webkit","O","ms"],y=document.createElement("div"),x=A.charAt(0).toUpperCase()+A.slice(1);for(var w=z.length;w--;){if((z[w]+x) in y.style){return("-"+z[w].toLowerCase()+"-")}}return false};var u=(function(){return{observe:function(y,x){var w=setInterval(function(){if(document.getElementById(y)){x(document.getElementById(y));clearInterval(w)}},60)}}})();var i=function i(){var x=document.body;if(document.createElement&&x&&x.appendChild&&x.removeChild){var z=document.createElement("div");if(!z.getBoundingClientRect){return null}z.innerHTML="x";z.style.cssText="position:fixed;top:100px;";x.appendChild(z);var A=x.style.height,B=x.scrollTop;x.style.height="3000px";x.scrollTop=500;var w=z.getBoundingClientRect().top;x.style.height=A;var y=(w===100);x.removeChild(z);x.scrollTop=B;return y}return null};var t=function t(y){if(y.type=="touchstart"){mobile.touching=true;if(y.touches.length==1){e.els.content.css(s("transition")+"transition","");var z=y.touches[0];if(z.target.onclick){z.target.onclick()}mobile.oX=z.pageX;mobile.nX=0;mobile.scrollX=0}}else{if(y.type=="touchmove"){y.preventDefault();mobile.scrollX=null;if(y.touches.length==1){var z=y.touches[0];mobile.nX=z.pageX;if(mobile.oX>mobile.nX){mobile.scrollX=-(mobile.oX-mobile.nX)}else{if(mobile.nX>mobile.oX){mobile.scrollX=mobile.nX-mobile.oX}}e.els.content.css(s("transform")+"transform","translateX("+(mobile.scrollX)+"px)")}}else{if(y.type=="touchend"||y.type=="touchcancel"){mobile.touching=false;var x=s("transition")+"transition",w="opacity "+e.settings.speed+"ms ease, "+s("transform")+"transform "+e.settings.speed+"ms ease";e.els.content.css(x,w);if(mobile.scrollX>140){o("prev")}else{if(mobile.scrollX<-(140)){o("next")}else{e.els.content.css(s("transform")+"transform","translateX(0px)")}}}else{}}}};e.init()};a.fn.glisse=function(b){return this.each(function(){if(undefined===a(this).data("glisse")){var c=new a.glisse(this,b);a(this).data("glisse",c)}})}})(jQuery);